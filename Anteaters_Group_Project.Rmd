---
title: "Aggregating Anteaters Project"
output: 
  html_document:
    number_sections: true
date: "2023-11-16"
---

```{r setup, include=FALSE}
# Formatting
knitr::opts_chunk$set(echo = FALSE,
                      warning = FALSE, # (JMEP) makes sure html doc doesn't print warnings
                      message = FALSE) # (JMEP) makes sure html doc doesn't print messages


# Load required libraries
library(tidyverse)
library(GGally)
library(ggplot2)
library(sjPlot)
library(kableExtra)
library(emmeans)
library(patchwork)
library(ggmosaic)


# Download data
source("https://edin.ac/4616rYu")
get_my_data(group_name = "aggregating_anteaters")

print_p <- function(p) {
  print <- ifelse(p < 0.001, "< 0.001", str_c("= ", round(p,3)))
  return(print)
}
```

# Data Preparation

```{r}
# (JMEP) cleaning data of weird values - see notes 
emoji_clean <- emoji |>
  filter(is.na(age) == F,
         age > 2,
         # opsys != "Windows",
         em_cat != "upside-down face",
         freq_emu >= 0) |>
  mutate(opsys = ifelse(opsys == "appple", "apple", opsys),
         opsys = factor(opsys, labels = c("Android", "Apple", "Windows")),
         em_cat_emoji = sapply(em_cat, emoji::emoji),
         em_cat = as.factor(em_cat),
         EI = as.factor(EI))

excl_tab <- emoji |> 
  mutate(
    exclusion_reason = ifelse(is.na(name) == T, 
                              "Name is missing",
                        ifelse(is.na(age) == T, 
                               "Age is missing",
                        ifelse(age < 7,
                               "Impossible or unlikely age",
                        ifelse(is.na(opsys) == T,
                               "Operating system is missing",
                        ifelse(is.na(freq_emu) == T,
                               "Frequency of Emoji use is missing",
                        ifelse(freq_emu < 0,
                               "Impossible frequency value (negative) is reported",
                        ifelse(is.na(em_cat) == T,
                               "Emoji category is missing",
                        ifelse(em_cat != "loudly crying face" &
                                 em_cat != "slightly smiling face" &
                                 em_cat != "thumbs up",
                               "Emoji not in study materials is reported",
                        ifelse(is.na(EVS) == T,
                               "Emotional valence score is missing",
                        ifelse(is.na(EI) == T,
                               "Emoji Interpretation is missing",
                               "not excluded"))))))))))) |>
  filter(exclusion_reason != "not excluded")
```

Before exploring the sample, initial checks were conducted to ensure that all observations were entered within their possible ranges (for continuous variables) or levels (for categorical variables). We excluded these along with any observation containing missing data (N~excluded~ = `r nrow(excl_tab)`). Table A1 provides an overview of excluded data points and the reason for exclusion. Additionally, the spelling of "Apple" was corrected in the operating system entry of `r nrow(filter(emoji, opsys=="appple"))` observations from "Appple". The marginal distributions and relationships amongst variables are visualised in Figure 1 (Figure A1 shows the same plots for pre-processed data).

**Figure 1** 
\
*Marginal distributions and between-variable relationships*

```{r fig.width=15, fig.height=15}
emoji_clean |> 
  select("age", "EVS", "freq_emu", "em_cat", "EI", "opsys") |>
  mutate(em_cat = factor(em_cat, labels = c("cry", "smile", "thumbs"))) |>
  ggpairs(columnLabels = c("Age", "Emotional Valence Score", "Frequency of Emoji Use", "Emoji Category", "Emoji Interpretation", "Operating System")) 
```

# Data Description

##Q1A - T-test

We explored whether there's a difference in the frequency of emoji use between Apple and Android users. We did this in two ways - we created violin plots, and conducted a Welch two sample t-test. 
 
From the violin plots below, we can see that the lower quartile and median of the two operating systems are very similar. However,  the upper quartile is higher and overall range is larger for Apple than Android. It seems that Apple users seem more likely to use a higher number of emojis per day. Android users however are more densely concentrated around the median. In the data set, we can see there is only one outlier - at 24 emojis per day for one Apple user.

```{r t-test and violin plot}
q1t_test <-t.test(freq_emu ~ opsys, data = filter(emoji_clean, opsys != "Windows"))

emoji_clean |>
  filter(opsys !="Windows") |>
ggplot(aes(x=opsys, y=freq_emu)) + geom_violin(alpha = 0.5) +
geom_boxplot(width=0.1) + xlab("Operating system") + ylab("Frequency of emoji use (emoji/day)") +
  labs(title="Frequency of use depending on operating system")
```
 
Following this, we conducted a Welch two sample t-test to assess whether the mean frequency of emoji use was different between Android (*n* = `r nrow(filter(emoji_clean, opsys == "Android"))` ; *m* = `r round(q1t_test$estimate [1],1)`; *sd* = `r round(sd(filter(emoji_clean, opsys == "Android")$freq_emu), 2)` and Apple users (*n* = `r nrow(filter(emoji_clean, opsys == "Apple"))`; *m* = `r round(q1t_test$estimate[2],2)`; *sd* = `r round(sd(filter(emoji_clean, opsys == "Apple")$freq_emu), 2)`). There was a significant difference in emoji use among Android and Apple users, *t*(`r round(q1t_test$parameter,2)`) = `r round(q1t_test$statistic,2 )`, *p* `r print_p(q1t_test$p.value)`, two-tailed). Therefore, we reject the null hypothesis that there is no difference in emoji use between Apple and Android users. From these two mechanisms, we have concluded that there is a difference between the two operating systems.

## Renia : Question 1b

```{r}
q1b_cortest <- cor.test(emoji_clean$age, emoji_clean$freq_emu)

mean_age <- mean(emoji_clean$age)
sd_age <- (emoji_clean$age)
mean_frq <- (emoji_clean$freq_emu)
sd_frq <- (emoji_clean$freq_emu)
```

Correlation test Interpretation

A correlation test was conducted to assess whether there is a relationship between the age of an individual, and the frequency by which they use emoji. A total of *n* = 235 individuals were included in the analysis, with a mean age of `r round(mean(emoji_clean$age),2 )`(*sd* = `r round(sd(emoji_clean$age),2 )`) and a mean frequency of use of emoji of `r round(mean(emoji_clean$freq_emu),2 )` (*sd* = `r round(sd(emoji_clean$freq_emu),2 )`).
There was a strong negative correlation between age of an individual and the frequency of emoji use. (*r* = -0.79, *t*(233) = -19.35, *p* < 0.001). We therefore reject the null hypothesis that there is no correlation between age and frequency of emoji use. Figure 1 provides a visualization of the relationship.



## Meg - 1c chisq tests and balance ----

```{r}
p1 <- ggplot(data = filter(emoji_clean, opsys != "Windows"), aes(x = em_cat, fill = opsys))+
  geom_bar(position = "dodge") +
  labs(fill = "Operating System Used", x = "Emoji Category", y = "Number of Participants")
```

Finally, we investigated whether there is a balance between Apple and Android users for each category of emoji. We conducted a $\chi^2$ goodness of fit test for each emoji category, which tests if the observed proportion of participants using Apple and Android deviates from hypothesised equal proportions of users (50% of the data each) indicating balance.

```{r chi square}
q1_chisq_cry <- emoji_clean |>
  filter((opsys == "Apple" | opsys == "Android") & em_cat == "loudly crying face") |>
  droplevels() |>
  select(opsys) |>
  table() |>
  chisq.test()

q1_chisq_smile <-emoji_clean |>
  filter((opsys == "Apple" | opsys == "Android") & em_cat == "slightly smiling face") |>
  droplevels() |>
  select(opsys) |>
  table() |>
  chisq.test()

q1_chisq_thumb <-emoji_clean |>
  filter((opsys == "Apple" | opsys == "Android") & em_cat == "thumbs up") |>
  droplevels() |>
  select(opsys) |>
  table() |>
  chisq.test()
```

For each emoji category, we found no significant difference between the observed proportions of Apple and Android users, and a hypothesised set of equal proportions. For loudly crying face emoji [`r emoji::emoji("loudly crying face")`], $\chi^2$ (`r q1_chisq_cry$parameter`) = `r round(q1_chisq_cry$statistic, 2)`, *p* `r print_p(q1_chisq_cry$p.value)` (*n* = `r nrow(filter(emoji_clean, opsys != "Windows" & em_cat == "loudly crying face"))`, *proportion~Apple~* = `r filter(prop, opsys == "Apple" & em_cat == "loudly crying face")$prop` %, *proportion~Android~* = `r filter(prop, opsys == "Android" & em_cat == "loudly crying face")$prop` %). For the slightly smiling face  emoji [`r emoji::emoji("slightly smiling face")`],  $\chi^2$ (`r q1_chisq_smile$parameter`) = `r round(q1_chisq_smile$statistic, 2)`, *p* `r print_p(q1_chisq_smile$p.value)` (*n* = `r nrow(filter(emoji_clean, opsys != "Windows" & em_cat == "slightly smiling face"))`, *proportion~Apple~* = `r filter(prop, opsys == "Apple" & em_cat == "slightly smiling face")$prop` %, *proportion~Android~* = `r filter(prop, opsys == "Android" & em_cat == "slightly smiling face")$prop` %). Finally, for the thumbs up emoji [`r emoji::emoji("thumbs up")`], $\chi^2$ (`r q1_chisq_thumb$parameter`) = `r round(q1_chisq_thumb$statistic, 2)`, *p* `r print_p(q1_chisq_thumb$p.value)` (*n* = `r nrow(filter(emoji_clean, opsys != "Windows" & em_cat == "thumbs up"))`, *proportion~Apple~* = `r filter(prop, opsys == "Apple" & em_cat == "thumbs up")$prop` %, *proportion~Android~* = `r filter(prop, opsys == "Android" & em_cat == "thumbs up")$prop` %).

# The Emotional Effect of Emojis

##Renia and Meg - model and interactions for Q2

One of the main aims we address in this research is the investigation of factors influencing emotional valence. We fitted a multiple regression model to predict whether the type of emoji and the frequency of use of the emoji, as well as the age of the participants, has an effect on their emotional valence. We mean-centered age for interpretation of coefficients and intercepts.

```{r}
# add interactions to address the aim that states "The researchers are interested in whether the age of the user also has an effect, although they are not sure whether the effect will be the same for all types of emoji."
contrasts(emoji_clean$em_cat) <- "contr.sum"

m2intq2 <- (lm(EVS ~ freq_emu + I(age-mean(age)) * em_cat , data = emoji_clean))
anova(m2intq2)
summary(m2intq2)
# plot interactions  
```

```{r}
emmeans(m2intq2, pairwise ~ em_cat * I(age-mean(age)))$contrasts |>
  kable(digits = 3) |>
  kable_styling()
```


# Accuracy of Emoji Interpretation

Finally, we address the research aim of what factors predict changes to likelihood in correctly interpreting the emoji according to the researchers' coding scheme. Given the binary outcome (correct vs. incorrect) and the variables of interest expressed by the researchers, we fitted a multiple logistic regression model to predict correct interpretation with frequency of Emoji use, age, emoji category, and the interaction between the latter two. Like the previous model, we mean-centered age for interpretation of coefficients and intercepts. Secondly, we used treatment coding (exact coding scheme in table **Ax**) for the emoji category such that each coefficient is the mean difference between the level and the grand mean, and that all other coefficients are interpreted across levels rather than within a reference level. The final model has the following equation:


$$
\log\left[ \frac {P(\operatorname{Emoji Interpretation} = \operatorname{correct})}{P(\operatorname{Emoji Interpretation} = \operatorname{incorrect})} \right] = \beta_0 + \beta_{1}(\operatorname{Emoji use frequency}) + \beta_{2}(\operatorname{Age_{mean-centered}}) + \beta_{3}·E_1 + \beta_{4}·E_2 + \beta_{5}(\operatorname{Age_{mean-centered}} \times \operatorname{E_1}) + \beta_{6}(\operatorname{Age_{mean-centered}} \times \operatorname{E_2})
$$

```{r 3. Accuracy of interpretation}
# JMEP

# hard coding failure = 0 and success = 1 for logistic regression
emoji_q3_analysis <- emoji_clean |>
  mutate(EI_bi = ifelse(EI == "incorrect", 0, 1))

# sum-to-zero contrast applied to emoji category
contrasts(emoji_q3_analysis$em_cat)<- "contr.sum"


m1q3 <- glm(EI_bi ~ freq_emu + I(age-mean(age))*em_cat, data = emoji_q3_analysis, family = binomial)

# Should we include these? just the estimated means

emmean_q3 <- contrast(emmeans(m1q3, ~ em_cat))
emmean_q3
```




**Table x**
\
*Logistic Regression Model*

```{r logistic model table}
tab_model(m1q3, 
          transform = "exp",
          show.stat=T, 
          dv.labels = "Correct Emoji Interpretation", 
          pred.labels = c("Intercept", 
                          "Emoji use frequency", 
                          "Age", 
                          str_c("Emoji [", emoji::emoji("loudly crying face"),"]"), 
                          str_c("Emoji [", emoji::emoji("slightly smiling face"),"]"), 
                          str_c("Age:Emoji [", emoji::emoji("loudly crying face"),"]"), 
                          str_c("Age:Emoji [", emoji::emoji("slightly smiling face"),"]")), 
          string.stat = "z-statistic ", 
          string.p = "p-value ", 
          string.ci = "95 % CI", 
          string.est = "Odds Ratio ",
          show.r2 = F,
          show.dev = T,
          show.loglik = T,
          show.se = T) 
```


Across emoji categories, the chance of correctly interpreting an emoji was. Which emoji was interpreted and emoji use frequency predicted no significant change in this likelihood. Age, on the other hand, reduced the predicted probability of correct interpretation; for each year above the sample mean, **xx**.

# Appendix A: Supplementary Tables and Figures

**Table A1** 
\
*Excluded observations and exclusion rationale*

```{r}
#need to work out how to capitalise the operating system names here

excl_tab |> 
  kable(col.names = c("Name", "Age", "Operating system", "Emoji use frequency", "Emoji category", "Emotional valence score", "Emoji Interpretation", "Reason for exlcusion")) |> 
  kable_styling()


```

**Figure A1** 
\
*Marginal distributions and between-variable relationships (pre-processed data)*

```{r}
emoji |> 
  select("age", "EVS", "freq_emu", "em_cat", "EI", "opsys") |>
  mutate(em_cat = factor(em_cat, labels = c("cry", "smile", "thumbs", "upside-down"))) |>
  ggpairs(
    #columnLabels = c("Age", "Emotional Valence Score", "Frequency of Emoji Use", "Emoji Category", "Emoji Interpretation", "Operating System")
    ) 
```


**Figure A x**
\
*Binned plot: Logistic Regression*
```{r}
arm::binnedplot(fitted(m1q3), 
                rstudent(m1q3, type = 'deviance'),
                xlab = 'Prob. of correct emoji interpretation', 
                ylab = 'Studentized Deviance Residuals')
```

**Figure A x**
\
*Standardised Deviance Residuals (Logistic Regression)*

```{r}
plot(rstandard(m1q3, type = 'deviance'),ylab = 'Studentized Deviance Residuals')
```
#Exam Numbers: "B155926, B239086, B239979, B244840, B246814"

# Notes for report (to be deleted)

(JMEP; 16/11/2023 - midnight zoomies) found this cool way of generating lm equation :0 equatiomatic

(JMEP; 16/11/2023 - midnight zoomies) Would be helpful if we could do all our code for each section in one chunk. Then we can call tables/figures where we need them and refer to numbers in inline code. Inline code example: `r mean(emoji$age)` (there is an NA in age, booo)

(JMEP; 16/11/2023 - midnight zoomies) I looked into age. There is one NA, one person who is -100 years old and one that is 1 year old. I think we can reliably remove them (done in emoji_clean). There are also a bunch (`r nrow(filter(emoji, is.na(age) == F & age < 18 & age > 1))` to be exact) that are under 18 (between `r range(filter(emoji, is.na(age) == F & age < 18 & age > 1)$age)[1]` and `r range(filter(emoji, is.na(age) == F & age < 18 & age > 1)$age)[2]`), whom I am not sure if we should remove??
I also noticed some other unusual stuff. Frequency ratings below 0, and a typo in "Apple" for one of the operating systems ("Appple"). There are also only two Windows users which isn't really helpful in terms of analysis - might wanna exclude them.

#Code to possibly be deleted:
```{r}
#ggplot for Q1b
ggplot(emoji_clean, aes(x=age, y=freq_emu)) + 
  geom_point() + 
  labs(x = "Age",
       y = "Frequency of emoji use per day",
       title = "Figure 1: Negative relationship between age and frequency of emoji use")+
  guides(fill="none") + 
  theme_light()

# proportion plot for Q1c
p2<- emoji_clean |>
  filter(opsys != "Windows") |>
  droplevels() |>
  group_by(em_cat,opsys)|>
  summarise(n = n()) |>
  mutate(total_n =sum(n[em_cat == em_cat]),
    prop = n/total_n) |>
  ggplot( aes(x = em_cat, y = prop, fill = opsys))+
  geom_col(position = "dodge")+
  ylim(0,1)


```

#probably to delete but just in case
For each emoji category, we found no significant difference between the observed proportions of Apple and Android users, and a hypothesised set of equal proportions. The results for each emoji category are as follows: loudly crying face emoji [`r emoji::emoji("loudly crying face")`]: *n* = `r nrow(filter(emoji_clean, opsys != "Windows" & em_cat == "loudly crying face"))`, *proportion~Apple~* = `r filter(prop, opsys == "Apple" & em_cat == "loudly crying face")$prop` %, *proportion~Android~* = `r filter(prop, opsys == "Android" & em_cat == "loudly crying face")$prop` %; $\chi^2$ (`r q1_chisq_cry$parameter`) = `r round(q1_chisq_cry$statistic, 2)`, *p* `r print_p(q1_chisq_cry$p.value)`; slightly smiling face  emoji [`r emoji::emoji("slightly smiling face")`]: *n* = `r nrow(filter(emoji_clean, opsys != "Windows" & em_cat == "slightly smiling face"))`, *proportion~Apple~* = `r filter(prop, opsys == "Apple" & em_cat == "slightly smiling face")$prop` %, *proportion~Android~* = `r filter(prop, opsys == "Android" & em_cat == "slightly smiling face")$prop` %; $\chi^2$ (`r q1_chisq_smile$parameter`) = `r round(q1_chisq_smile$statistic, 2)`, *p* `r print_p(q1_chisq_smile$p.value)`; thumbs up emoji [`r emoji::emoji("thumbs up")`]: *n* = `r nrow(filter(emoji_clean, opsys != "Windows" & em_cat == "thumbs up"))`, *proportion~Apple~* = `r filter(prop, opsys == "Apple" & em_cat == "thumbs up")$prop` %, *proportion~Android~* = `r filter(prop, opsys == "Android" & em_cat == "thumbs up")$prop` %; $\chi^2$ (`r q1_chisq_thumb$parameter`) = `r round(q1_chisq_thumb$statistic, 2)`, *p* `r print_p(q1_chisq_thumb$p.value)`.