---
title: "Aggregating Anteaters Project"
output: 
  html_document:
    number_sections: true
date: "2023-11-16"
---

```{r setup, include=FALSE}
# Formatting
knitr::opts_chunk$set(echo = FALSE,
                      warning = FALSE, # (JMEP) makes sure html doc doesn't print warnings
                      message = FALSE) # (JMEP) makes sure html doc doesn't print messages


# Load required libraries
library(tidyverse)
library(GGally)
library(ggplot2)
library(sjPlot)



library(kableExtra)
library(emmeans)


# Download data
source("https://edin.ac/4616rYu")
get_my_data(group_name = "aggregating_anteaters")

or_p <- function(or, log = T) {
  if (log == T)
    or = exp(or)
  p = or/(1+or)
  return(p)
}
```

# Data Preparation

```{r}
# (JMEP) cleaning data of weird values - see notes 
emoji_clean <- emoji |>
  filter(is.na(age) == F,
         age > 2,
         # opsys != "windows",
         em_cat != "upside-down face",
         freq_emu >= 0) |>
  mutate(opsys = ifelse(opsys == "appple", "apple", opsys),
         opsys = as.factor(opsys),
         em_cat_emoji = sapply(em_cat, emoji::emoji),
         em_cat = as.factor(em_cat),
         EI = as.factor(EI))

excl_tab <- emoji |> 
  mutate(
    exclusion_reason = ifelse(is.na(name) == T, 
                              "Name is missing",
                        ifelse(is.na(age) == T, 
                               "Age is missing",
                        ifelse(age < 7,
                               "Impossible or unlikely age",
                        ifelse(is.na(opsys) == T,
                               "Operating system is missing",
                        ifelse(is.na(freq_emu) == T,
                               "Frequency of Emoji use is missing",
                        ifelse(freq_emu < 0,
                               "Impossible frequency value (negative) is reported",
                        ifelse(is.na(em_cat) == T,
                               "Emoji category is missing",
                        ifelse(em_cat != "loudly crying face" &
                                 em_cat != "slightly smiling face" &
                                 em_cat != "thumbs up",
                               "Emoji not in study materials is reported",
                        ifelse(is.na(EVS) == T,
                               "Emotional valence score is missing",
                        ifelse(is.na(EI) == T,
                               "Emoji Interpretation is missing",
                               "not excluded"))))))))))) |>
  filter(exclusion_reason != "not excluded")
```

Before exploring the sample, initial checks were conducted to ensure that all observations were entered within their possible ranges (for continuous variables) or levels (for categorical variables). We excluded these along with any observation containing missing data (N~excluded~ = `r nrow(excl_tab)`). Table A1 provides an overview of excluded data points and the reason for exclusion. Additionally, the spelling of "Apple" was corrected in the operating system entry of `r nrow(filter(emoji, opsys=="appple"))` observations from "Appple". The marginal distributions and relationships amongst variables are visualised in Figure 1 (Figure A1 shows the same plots for pre-processed data).

**Figure 1** 
\
*Marginal distributions and between-variable relationships*

```{r fig.width=15, fig.height=15}
# (JMEP) pretty paris panel

emoji_clean |> 
  select(-c("name", "em_cat_emoji")) |>
  mutate(em_cat = factor(em_cat, labels = c("cry", "smile", "thumbs"))) |>
  ggpairs()
```

# Data Description

##JRB Question 1a - Whether there’s any difference in the frequency of emoji use between apple and android users.


```{r}
q1t_test <-t.test(freq_emu ~ opsys, data = filter(emoji_clean, opsys != "windows"))
```

A Welch two sample t-test was used to assess whether the mean frequency of emoji use was different between apple (*n* = ) and android users (*n* = ). There was a significant difference in emoji use among apple users (*M* = ; *SD* = ) and android users (*M* = ; *SD*= )(*t*(`r round(q1t_test$statistic,2 )`) = -2.85, *p* = , two-tailed). Therefore, we reject the null hypothesis that there is no difference in emoji use between apple and android users. 


# Ella - 1a violin plots
```{r}
ggplot(data=filter(emoji_clean, opsys != "windows"), aes(x=opsys, y=freq_emu)) + geom_violin(alpha = 0.5) +
geom_boxplot(width=0.1) + xlab("Operating system") + ylab("Frequency of emoji use (emoji/day)") +
  labs(title="Frequency of use depending on operating system")

```


1a: Whether there’s any difference in the frequency of emoji use between apple and android users.
From the violin plots above/below, it is clear that the lower quartile and median are very similar, if not the same, for the two operating systems. However, the upper quartile is higher and overall range is larger for Apple than Android. It seems that Apple users seem more likely to use a higher number of emojis per day. Android users however are more densely concentrated around the median. In the data set, we can see there is only one outlier - at 24 emojis per day for one Apple user.


## Renia : Question 1b


```{r}

q1b_cortest <- cor.test(emoji_clean$age, emoji_clean$freq_emu)

mean_age <- mean(emoji_clean$age)
sd_age <- (emoji_clean$age)
mean_frq <- (emoji_clean$freq_emu)
sd_frq <- (emoji_clean$freq_emu)


```
### Interpretation for Correlation test, Q1b:

A correlation test was conducted to assess whether there is a relationship between the age of an individual, and the frequency by which they use emoji. A total of 235 individuals where included in the analysis, with a mean age of `r nrow(mean_age)`(*SD* = `r nrow(sd_age)`) and a mean frequency of use of emoji of `r nrow(mean_frq)` (*SD* = `r nrow(sd_frq)`).
There was a strong negative correlation between a geographical age of an individual and the frequency of emoji use. (*r* = -0.79, t(233)= -19.35 , *p* < 0.001). We therefore reject the null hypothesis that there is no correlation between an area’s school attendance and attainment. Figure 1 provides a visualization of the relationship.


## Meg - 1c chisq tests and balance ----
```{r}
q1_chisq <- chisq.test(table(emoji_clean$opsys, emoji_clean$em_cat))
# so there is no significant association between which operating system you use and your  emoji category
# but is there a balance? 
# the null hyp would state that each emoji should be presented with the same frequencies
# but the table shows us that apple was more frequently shown each type of emoji than android
```

```{r}
# so we can build a mosaic plot to represent expected vs observed levels of each emoji being presented
contin_tab <- emoji_clean |>
  select(opsys, em_cat) |>
  table() |>
  addmargins()
# a beautiful contingency table
t <- emoji_clean |>
  select(opsys, em_cat) |>
  table()
# now we add expected values
e <- rowSums(t) %o%
  colSums(t)/sum(t)
```
```{r}
# plot
observed1c <- plot(t)
```
```{r}
#plot
expected1c <- plot(as.table(e))

```
# The Emotional Effect of Emojis

# Accuracy of Emoji Interpretation

Finally, we address the research aim of what factors predicts changes to likelihood in correctly interpreting the Emoji according to the researchers' coding scheme. We fitted a multiple logistic regression model to predict correct interpretation with frequency of Emoji use, 
account for the binary nature of the outcome variable.

```{r 3. Accuracy of interpretation}
# JMEP

# hard coding failure = 0 and success = 1 for logistic regression
emoji_q2_analysis <- emoji_clean |>
  mutate(EI_bi = ifelse(EI == "incorrect", 0, 1))

# sum-to-zero contrast applied to emoji category
contrasts(emoji_q2_analysis$em_cat)<- "contr.sum"


m1q3 <- glm(EI_bi ~ freq_emu + I(age-mean(age))*em_cat, data = emoji_q2_analysis, family = binomial)

# Should we include these? just the estimated means

emmean_q2 <- contrast(emmeans(m1q3, ~ em_cat))
emmean_q2
```


$$
\log\left[ \frac { P( \operatorname{Emoji Interpretation} = \operatorname{correct} ) }{ P( \operatorname{Emoji Interpretation} = \operatorname{incorrect} ) } \right] = \beta_0 + \beta_{1}(\operatorname{Emoji use frequency}) + \beta_{2}(\operatorname{Age}) + \beta_{3}(\operatorname{em\_cat}_{\operatorname{1}}) + \beta_{4}(\operatorname{em\_cat}_{\operatorname{2}}) + \beta_{5}(\operatorname{Age} \times \operatorname{em\_cat}_{\operatorname{1}}) + \beta_{6}(\operatorname{Age} \times \operatorname{em\_cat}_{\operatorname{2}})
$$

**Table x**
\
*Logistic Regression Model*

```{r}
tab_model(m1q3, 
          transform = "exp",
          show.stat=T, 
          dv.labels = "Correct Emoji Interpretation", 
          pred.labels = c("Intercept", 
                          "Emoji use frequency", 
                          "Age", 
                          str_c("Emoji [", emoji::emoji("loudly crying face"),"]"), 
                          str_c("Emoji [", emoji::emoji("slightly smiling face"),"]"), 
                          str_c("Age:Emoji [", emoji::emoji("loudly crying face"),"]"), 
                          str_c("Age:Emoji [", emoji::emoji("slightly smiling face"),"]")), 
          string.stat = "z-statistic ", 
          string.p = "p-value ", 
          string.ci = "95 % CI", 
          string.est = "Odds Ratio ",
          show.r2 = F,
          show.dev = T,
          show.loglik = T,
          show.se = T) 
```

**Needs p-values, z-stats, and CIs**

Across emoji categories, the chance of correctly interpreting an emoji was `r or_p(as.numeric(coef(m1q3)[1]))*100` %. Which emoji was interpreted and emoji use frequency predicted no significant change in this likelihood. Age, on the other hand, reduced the predicted probability of correct interpretation; for each year above the sample mean, **xx** `r or_p(as.numeric(coef(m1q3)[3]))*100` % .

# Appendix A: Supplementary Tables and Figures

**Table A1** 
\
*Excluded observations and exclusion rationale*

```{r}
excl_tab |> 
  kable(col.names = c("Name", "Age", "Operating system", "Emoji use frequency", "Emoji category", "Emotional valence score", "Emoji Interpretation", "Reason for exlcusion")) |> 
  kable_styling()
```

**Figure A1** 
\
*Marginal distributions and between-variable relationships (pre-processed data)*

```{r}
emoji |> 
  select(-c("name")) |>
  mutate(em_cat = factor(em_cat, labels = c("cry", "smile", "thumbs", "upside-down")),
         EI = as.factor(EI),
         opsys = as.factor(opsys)) |>
  ggpairs()
```


**Figure A x**
\
*Binned plot: Logistic Regression*
```{r}
arm::binnedplot(fitted(m1q3), 
                rstudent(m1q3, type = 'deviance'),
                xlab = 'Prob. of correct emoji interpretation', 
                ylab = 'Studentized Deviance Residuals')
```

**Figure A x**
\
*Standardised Deviance Residuals (Logistic Regression)*

```{r}
plot(rstandard(m1q3, type = 'deviance'),ylab = 'Studentized Deviance Residuals')
```


# Notes for report (to be deleted)

(JMEP; 16/11/2023 - midnight zoomies) found this cool way of generating lm equation :0 equatiomatic

(JMEP; 16/11/2023 - midnight zoomies) Would be helpful if we could do all our code for each section in one chunk. Then we can call tables/figures where we need them and refer to numbers in inline code. Inline code example: `r mean(emoji$age)` (there is an NA in age, booo)

(JMEP; 16/11/2023 - midnight zoomies) I looked into age. There is one NA, one person who is -100 years old and one that is 1 year old. I think we can reliably remove them (done in emoji_clean). There are also a bunch (`r nrow(filter(emoji, is.na(age) == F & age < 18 & age > 1))` to be exact) that are under 18 (between `r range(filter(emoji, is.na(age) == F & age < 18 & age > 1)$age)[1]` and `r range(filter(emoji, is.na(age) == F & age < 18 & age > 1)$age)[2]`), whom I am not sure if we should remove??
I also noticed some other unusual stuff. Frequency ratings below 0, and a typo in "Apple" for one of the operating systems ("Appple"). There are also only two windows users which isn't really helpful in terms of analysis - might wanna exclude them.


#Code to possisbly be deleted:
```{r}
#ggplot for Q1b
ggplot(emoji_clean, aes(x=age, y=freq_emu)) + 
  geom_point() + 
  labs(x = "Age",
       y = "Frequency of emoji use per day",
       title = "Figure 1: Negative relationship between age and frequency of emoji use")+
  guides(fill="none") + 
  theme_light()
```

